{
  "deployment": {
    "subscriptionId": "your-subscription-id-here",
    "resourceGroupName": "sql-ha-multi-subnet",
    "location": "East US",
    "deploymentName": "sql-ha-multi-subnet-deployment",
    "tags": {
      "Environment": "Production",
      "Project": "SQL-HA-MultiSubnet",
      "Owner": "DBA-Team",
      "CostCenter": "IT-Database",
      "DeploymentMethod": "AzureCLI",
      "Architecture": "MultiSubnet"
    }
  },
  "network": {
    "virtualNetworkName": "sql-ha-vnet",
    "addressSpace": "10.2.0.0/16",
    "subnets": {
      "domain": {
        "name": "domain-subnet",
        "addressPrefix": "10.2.1.0/24",
        "subnetMask": "/24"
      },
      "sql1": {
        "name": "sql1-subnet",
        "addressPrefix": "10.2.2.0/24",
        "subnetMask": "/24"
      },
      "sql2": {
        "name": "sql2-subnet",
        "addressPrefix": "10.2.3.0/24",
        "subnetMask": "/24"
      },
      "witness": {
        "name": "witness-subnet",
        "addressPrefix": "10.2.4.0/24",
        "subnetMask": "/24"
      },
      "management": {
        "name": "management-subnet",
        "addressPrefix": "10.2.10.0/24",
        "subnetMask": "/24"
      }
    },
    "networkSecurityGroup": {
      "name": "sql-ha-nsg",
      "rules": [
        {
          "name": "AllowRDP",
          "priority": 1000,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowSQL",
          "priority": 1100,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "1433",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowSQLBrowser",
          "priority": 1200,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "1434",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowAGEndpoint",
          "priority": 1300,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5022",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowClusterCommunication",
          "priority": 1400,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "3343",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowWinRM",
          "priority": 1500,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5985-5986",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowDNS",
          "priority": 1600,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "53",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowKerberos",
          "priority": 1700,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "88",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowLDAP",
          "priority": 1800,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "389",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        },
        {
          "name": "AllowLDAPS",
          "priority": 1900,
          "direction": "Inbound",
          "access": "Allow",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "636",
          "sourceAddressPrefix": "10.2.0.0/16",
          "destinationAddressPrefix": "*"
        }
      ]
    }
  },
  "domainController": {
    "vmName": "sql-ha-dc",
    "vmSize": "Standard_D2s_v3",
    "adminUsername": "azureuser",
    "adminPassword": "P@ssw0rd123!",
    "domainName": "contoso.local",
    "domainNetbiosName": "CONTOSO",
    "safeModePwd": "P@ssw0rd123!",
    "privateIpAddress": "10.2.1.4",
    "subnetName": "domain-subnet",
    "osDiskType": "Premium_LRS",
    "dataDiskSizeGB": 128,
    "dataDiskType": "Premium_LRS"
  },
  "sqlServers": {
    "vmSize": "Standard_E8s_v3",
    "adminUsername": "azureuser",
    "adminPassword": "P@ssw0rd123!",
    "sqlServiceAccount": "sqlservice",
    "sqlServicePassword": "P@ssw0rd123!",
    "sqlAgentAccount": "sqlagent",
    "sqlAgentPassword": "P@ssw0rd123!",
    "sqlServerEdition": "Enterprise",
    "sqlServerVersion": "2022",
    "osDiskType": "Premium_LRS",
    "dataDiskSizeGB": 2047,
    "dataDiskType": "Premium_LRS",
    "logDiskSizeGB": 1023,
    "logDiskType": "Premium_LRS",
    "tempDbDiskSizeGB": 512,
    "tempDbDiskType": "Premium_LRS",
    "nodes": [
      {
        "vmName": "sql-ha-primary",
        "privateIpAddress": "10.2.2.4",
        "subnetName": "sql1-subnet",
        "role": "primary",
        "availabilityZone": "1"
      },
      {
        "vmName": "sql-ha-secondary",
        "privateIpAddress": "10.2.3.4",
        "subnetName": "sql2-subnet",
        "role": "secondary",
        "availabilityZone": "2"
      }
    ]
  },
  "cluster": {
    "name": "SQL-HA-Cluster",
    "ipAddress": "10.2.2.20",
    "subnetMask": "255.255.255.0",
    "witnessType": "FileShareWitness",
    "witnessServer": "sql-ha-witness",
    "witnessShare": "\\\\sql-ha-witness\\witness"
  },
  "availabilityGroup": {
    "name": "AG-Production",
    "listenerName": "AG-Listener",
    "listenerIpAddress": "10.2.2.21",
    "listenerPort": 1433,
    "databases": [
      "AdventureWorks2022",
      "MyAppDatabase",
      "ReportingDB"
    ],
    "backupPreference": "Secondary",
    "failureConditionLevel": 3,
    "healthCheckTimeout": 30000,
    "replicas": [
      {
        "serverName": "sql-ha-primary",
        "availabilityMode": "SYNCHRONOUS_COMMIT",
        "failoverMode": "AUTOMATIC",
        "backupPriority": 30,
        "connectionModeInPrimaryRole": "ALLOW_ALL_CONNECTIONS",
        "connectionModeInSecondaryRole": "ALLOW_READ_ONLY_CONNECTIONS",
        "readOnlyRoutingUrl": "TCP://sql-ha-primary.contoso.local:1433"
      },
      {
        "serverName": "sql-ha-secondary",
        "availabilityMode": "SYNCHRONOUS_COMMIT",
        "failoverMode": "AUTOMATIC",
        "backupPriority": 50,
        "connectionModeInPrimaryRole": "ALLOW_ALL_CONNECTIONS",
        "connectionModeInSecondaryRole": "ALLOW_READ_ONLY_CONNECTIONS",
        "readOnlyRoutingUrl": "TCP://sql-ha-secondary.contoso.local:1433"
      }
    ],
    "readOnlyRouting": {
      "enabled": true,
      "readOnlyReplicas": [
        "sql-ha-secondary"
      ]
    }
  },
  "loadBalancer": {
    "name": "sql-ha-lb",
    "type": "Internal",
    "frontendIpAddress": "10.2.2.21",
    "backendPoolName": "sql-backend-pool",
    "healthProbeName": "sql-health-probe",
    "healthProbePort": 59999,
    "healthProbeProtocol": "Tcp",
    "healthProbeIntervalSeconds": 5,
    "healthProbeNumberOfProbes": 2,
    "loadBalancingRules": [
      {
        "name": "SQLRule",
        "frontendPort": 1433,
        "backendPort": 1433,
        "protocol": "Tcp",
        "enableFloatingIP": true,
        "idleTimeoutMinutes": 4
      }
    ]
  },
  "storage": {
    "storageAccountName": "sqlhamultistorage",
    "storageAccountType": "Standard_LRS",
    "containerNames": [
      "backups",
      "logs",
      "scripts",
      "reports"
    ],
    "fileShares": [
      {
        "name": "witness",
        "quota": 5
      },
      {
        "name": "backups",
        "quota": 100
      }
    ]
  },
  "security": {
    "enableEncryption": true,
    "certificateName": "SQLHACert",
    "keyVaultName": "sql-ha-multi-keyvault",
    "enableTDE": true,
    "enableBackupEncryption": true,
    "enableAlwaysEncrypted": true,
    "firewallRules": [
      {
        "name": "AllowVNet",
        "startIpAddress": "10.2.0.0",
        "endIpAddress": "10.2.255.255"
      },
      {
        "name": "AllowManagement",
        "startIpAddress": "10.2.10.0",
        "endIpAddress": "10.2.10.255"
      }
    ]
  },
  "serviceAccounts": {
    "sqlServiceAccount": {
      "username": "CONTOSO\\sqlservice",
      "password": "P@ssw0rd123!",
      "description": "SQL Server Database Engine Service Account"
    },
    "sqlAgentAccount": {
      "username": "CONTOSO\\sqlagent",
      "password": "P@ssw0rd123!",
      "description": "SQL Server Agent Service Account"
    },
    "clusterServiceAccount": {
      "username": "CONTOSO\\clusterservice",
      "password": "P@ssw0rd123!",
      "description": "Windows Server Failover Cluster Service Account"
    },
    "backupAccount": {
      "username": "CONTOSO\\sqlbackup",
      "password": "P@ssw0rd123!",
      "description": "SQL Server Backup Service Account"
    }
  },
  "monitoring": {
    "enableSqlInsights": true,
    "logAnalyticsWorkspace": "sql-ha-multi-logs",
    "retentionDays": 90,
    "alertRules": [
      {
        "name": "High CPU Usage",
        "metric": "Percentage CPU",
        "threshold": 80,
        "operator": "GreaterThan",
        "timeAggregation": "Average",
        "windowSize": "PT5M",
        "frequency": "PT1M"
      },
      {
        "name": "Low Disk Space",
        "metric": "Disk Free Space %",
        "threshold": 10,
        "operator": "LessThan",
        "timeAggregation": "Average",
        "windowSize": "PT5M",
        "frequency": "PT5M"
      },
      {
        "name": "AG Synchronization Health",
        "metric": "Synchronization Health",
        "threshold": 1,
        "operator": "LessThan",
        "timeAggregation": "Average",
        "windowSize": "PT1M",
        "frequency": "PT1M"
      },
      {
        "name": "High Memory Usage",
        "metric": "Memory Usage %",
        "threshold": 90,
        "operator": "GreaterThan",
        "timeAggregation": "Average",
        "windowSize": "PT5M",
        "frequency": "PT1M"
      },
      {
        "name": "Long Running Queries",
        "metric": "Query Duration",
        "threshold": 300,
        "operator": "GreaterThan",
        "timeAggregation": "Maximum",
        "windowSize": "PT5M",
        "frequency": "PT1M"
      }
    ],
    "performanceCounters": [
      "\\SQLServer:Buffer Manager\\Page life expectancy",
      "\\SQLServer:Buffer Manager\\Buffer cache hit ratio",
      "\\SQLServer:SQL Statistics\\Batch Requests/sec",
      "\\SQLServer:SQL Statistics\\SQL Compilations/sec",
      "\\SQLServer:Availability Replica(*)\\Bytes Sent to Replica/sec",
      "\\SQLServer:Database Replica(*)\\Log Send Queue",
      "\\SQLServer:Database Replica(*)\\Redo Queue"
    ]
  },
  "witness": {
    "type": "FileShareWitness",
    "vmName": "sql-ha-witness",
    "vmSize": "Standard_D2s_v3",
    "privateIpAddress": "10.2.4.4",
    "subnetName": "witness-subnet",
    "availabilityZone": "3",
    "shareName": "witness",
    "shareSize": 5
  },
  "backup": {
    "strategy": "Hybrid",
    "localRetentionDays": 7,
    "azureRetentionDays": 30,
    "longTermRetentionYears": 7,
    "backupSchedule": {
      "fullBackup": {
        "frequency": "Weekly",
        "dayOfWeek": "Sunday",
        "time": "02:00"
      },
      "differentialBackup": {
        "frequency": "Daily",
        "time": "22:00"
      },
      "logBackup": {
        "frequency": "Every15Minutes"
      }
    },
    "compression": true,
    "encryption": true,
    "checksum": true
  },
  "disasterRecovery": {
    "enabled": true,
    "drRegion": "West US 2",
    "drResourceGroup": "sql-ha-dr",
    "replicationMode": "Asynchronous",
    "rpoMinutes": 15,
    "rtoMinutes": 30,
    "testFailoverSchedule": "Monthly"
  }
}

